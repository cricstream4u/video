<html>
    <head>
        <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    </head>
    <body>
        <div style="width:100%; height: auto">
            <video preload="none" id="player" autoplay controls crossorigin poster="">
            </video>
        </div>

        <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
        <script>
            // Function to get URL parameters
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    source: params.get('source') || '',
                    poster: params.get('poster') || '',
                };
            }

            document.addEventListener("DOMContentLoaded", () => {
                const { source, poster } = getUrlParams();
                const video = document.querySelector("video");

                // Set poster dynamically
                if (poster) {
                    video.setAttribute('poster', poster);
                }

                const defaultOptions = {};
                let player;

                if (source && Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(source);
                    hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                        const availableQualities = hls.levels.map((l) => l.height);
                        defaultOptions.controls = [
                            'play-large',
                            'play',
                            'progress',
                            'duration',
                            'live',
                            'mute',
                            'settings',
                            'pip',
                            'airplay',
                            'fullscreen',
                        ];

                        defaultOptions.quality = {
                            default: 0,
                            options: availableQualities,
                            forced: true,
                            onChange: (e) => updateQuality(e),
                        };

                        defaultOptions.i18n = {
                            qualityLabel: {
                                0: "Auto",
                            },
                        };

                        player = new Plyr(video, defaultOptions);
                    });

                    hls.attachMedia(video);
                    window.hls = hls;
                } else if (!source) {
                    console.error("No video source provided in URL parameters.");
                }

                function updateQuality(newQuality) {
                    if (newQuality === 0) {
                        window.hls.currentLevel = -1;
                    } else {
                        window.hls.levels.forEach((level, levelIndex) => {
                            if (level.height === newQuality) {
                                window.hls.currentLevel = levelIndex;
                            }
                        });
                    }
                }
            });
        </script>
    </body>
</html>
